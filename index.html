<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Report S.O Harian</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #3b82f6 0%, #bf0004 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
        transition: all 0.3s ease;
      }
      .login-form {
        display: block;
      }
      .portal-content {
        display: none;
      }
      .logo {
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo h1 {
        color: #4285f4;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .logo p {
        color: #666;
        font-size: 0.9rem;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 500;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }
      input[type="text"]:focus,
      input[type="password"]:focus {
        outline: none;
        border-color: #4285f4;
        background: #fff;
        transform: translateY(-1px);
      }
      .login-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
      }
      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(66, 133, 244, 0.3);
      }
      .error-message, .success-message {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.9rem;
        display: none;
        padding: 10px;
        border-radius: 5px;
      }
      .error-message {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.2);
      }
      .success-message {
        color: #28a745;
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.2);
      }
      .drive-section {
        text-align: center;
        margin-bottom: 2rem;
      }
      .drive-connect-btn {
        background: #4285f4;
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin: 10px;
        transition: all 0.3s ease;
      }
      .drive-connect-btn:hover {
        background: #3367d6;
        transform: translateY(-1px);
      }
      .drive-connect-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .file-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 1rem;
      }
      .file-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .file-item:hover {
        background: #f5f5f5;
      }
      .file-item:last-child {
        border-bottom: none;
      }
      .file-icon {
        margin-right: 10px;
        font-size: 1.2rem;
      }
      .file-info {
        flex-grow: 1;
      }
      .file-name {
        font-weight: 500;
        margin-bottom: 2px;
      }
      .file-details {
        font-size: 0.8rem;
        color: #666;
      }
      .file-button {
        background: #4285f4;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.2s ease;
      }
      .file-button:hover {
        background: #3367d6;
      }
      .logout-btn {
        background: #dc3545;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 1rem;
        width: 100%;
      }
      .logout-btn:hover {
        background: #c82333;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #4285f4;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .status-indicator {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 1rem;
        text-align: center;
      }
      .status-connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Login Form -->
      <div id="loginForm" class="login-form">
        <div class="logo">
          <h1>üåæ S.O</h1>
          <p>Report Harian Stock Opname</p>
        </div>

        <form id="loginFormElement">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required />
          </div>

          <button type="submit" class="login-btn">
            <span id="loginBtnText">Login</span>
          </button>
        </form>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
      </div>

      <!-- Portal Content -->
      <div id="portalContent" class="portal-content">
        <div class="logo">
          <h1>üåæ Portal Dashboard</h1>
          <p>Welcome back!</p>
        </div>

        <div id="driveStatus" class="status-indicator status-disconnected">
          üìÇ Google Drive: Not Connected
        </div>

        <div class="drive-section">
          <button id="connectDriveBtn" class="drive-connect-btn">
            Connect to Google Drive
          </button>
          <button id="disconnectDriveBtn" class="drive-connect-btn" style="display: none; background: #dc3545;">
            Disconnect Drive
          </button>
          <button
            id="refreshFilesBtn"
            class="drive-connect-btn"
            style="display: none"
          >
            Refresh Files
          </button>
        </div>

        <div id="driveContent" style="display: none">
          <h3>üìÅ Your Google Drive Files</h3>
          <div id="fileList" class="file-list"></div>
        </div>

        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>

    <script>
      const USERS = {
          admin: "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a918",
          user: "04f8996da763b7a969b1028ee3007569eaf3a635486ddab211d512c85b9df8fb",
        };

      const GOOGLE_CONFIG = {
          client_id: "30896238069-4qccgpqt8iu5935v1fa7qbag7ve36m3m.apps.googleusercontent.com",
          api_key: "AIzaSyBBWWwug-UcevBmNa7sgypGFZjLfpZusEo",
          scopes: "https://www.googleapis.com/auth/drive.readonly",
      };

      let google_initialized = false;
      let current_user = null;
      let accessToken = null;
      let tokenClient = null;

      function hashPassword(password) {
        return CryptoJS.SHA256(password).toString();
      }

      function showElement(id) {
        document.getElementById(id).style.display = "block";
      }

      function hideElement(id) {
        document.getElementById(id).style.display = "none";
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";
        setTimeout(() => errorElement.style.display = "none", 5000);
      }

      function showSuccess(message) {
        const successElement = document.getElementById("successMessage");
        successElement.textContent = message;
        successElement.style.display = "block";
        setTimeout(() => successElement.style.display = "none", 3000);
      }

      // Login form handler
      document
        .getElementById("loginFormElement")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const hashedPassword = hashPassword(password);
          
          if (USERS[username] && USERS[username] === hashedPassword) {
            current_user = username;
            showSuccess("Login successful!");
            setTimeout(() => {
              hideElement("loginForm");
              showElement("portalContent");
              loadGoogleServices();
            }, 1000);
          } else {
            showError("Invalid username or password");
          }
        });

      function loadGoogleServices() {
        // Load Google Identity Services
        if (typeof google === "undefined" || !google.accounts) {
          const gisScript = document.createElement("script");
          gisScript.src = "https://accounts.google.com/gsi/client";
          gisScript.onload = () => {
            google_initialized = true;
            initializeTokenClient();
            checkExistingAuth();
            console.log("‚úÖ Google Identity Services loaded successfully");
          };
          gisScript.onerror = () => {
            showError("Failed to load Google Identity Services.");
          };
          document.head.appendChild(gisScript);
        } else {
          google_initialized = true;
          initializeTokenClient();
          checkExistingAuth();
        }
      }

      function initializeTokenClient() {
        try {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CONFIG.client_id,
            scope: GOOGLE_CONFIG.scopes,
            callback: handleAuthCallback,
          });
        } catch (error) {
          console.error("Error initializing token client:", error);
        }
      }

      function checkExistingAuth() {
        // Check if we have a stored valid token
        const storedToken = sessionStorage.getItem('google_drive_token');
        const tokenExpiry = sessionStorage.getItem('google_drive_token_expiry');
        
        if (storedToken && tokenExpiry) {
          const now = Date.now();
          const expiry = parseInt(tokenExpiry);
          
          if (now < expiry) {
            // Token is still valid
            accessToken = storedToken;
            updateDriveStatus(true);
            showElement("driveContent");
            showElement("refreshFilesBtn");
            hideElement("connectDriveBtn");
            loadDriveFiles();
            console.log("‚úÖ Using existing Google Drive authentication");
            return;
          } else {
            // Token expired, clean up
            sessionStorage.removeItem('google_drive_token');
            sessionStorage.removeItem('google_drive_token_expiry');
          }
        }
        
        // No valid token, show connect button
        updateDriveStatus(false);
      }

      // Connect to Google Drive
      document
        .getElementById("connectDriveBtn")
        .addEventListener("click", async function () {
          if (!google_initialized || !tokenClient) {
            showError("Google services not ready. Please wait a moment and try again.");
            return;
          }

          try {
            tokenClient.requestAccessToken({ prompt: 'consent' });
          } catch (error) {
            console.error("Error requesting access token:", error);
            showError("Failed to authenticate. Please try again.");
          }
        });

      function handleAuthCallback(tokenResponse) {
        if (tokenResponse && tokenResponse.access_token) {
          accessToken = tokenResponse.access_token;
          
          // Store token with expiry time (default is 1 hour)
          const expiryTime = Date.now() + (tokenResponse.expires_in ? tokenResponse.expires_in * 1000 : 3600000);
          sessionStorage.setItem('google_drive_token', accessToken);
          sessionStorage.setItem('google_drive_token_expiry', expiryTime.toString());
          
          updateDriveStatus(true);
          showElement("driveContent");
          showElement("refreshFilesBtn");
          hideElement("connectDriveBtn");
          loadDriveFiles();
          showSuccess("Successfully connected to Google Drive!");
          console.log("‚úÖ Google Drive connected and token stored");
        } else {
          console.error("Authentication failed:", tokenResponse);
          showError("Authentication failed. Please try again.");
        }
      }

      function updateDriveStatus(connected) {
        const statusElement = document.getElementById("driveStatus");
        const connectBtn = document.getElementById("connectDriveBtn");
        const disconnectBtn = document.getElementById("disconnectDriveBtn");
        
        if (connected) {
          statusElement.textContent = "üìÇ Google Drive: Connected";
          statusElement.className = "status-indicator status-connected";
          connectBtn.style.display = "none";
          disconnectBtn.style.display = "inline-block";
        } else {
          statusElement.textContent = "üìÇ Google Drive: Not Connected";
          statusElement.className = "status-indicator status-disconnected";
          connectBtn.style.display = "inline-block";
          disconnectBtn.style.display = "none";
        }
      }

      async function loadDriveFiles() {
        const fileListElement = document.getElementById("fileList");
        fileListElement.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

        if (!accessToken) {
          fileListElement.innerHTML = '<div class="loading" style="color: #dc3545;">Not authenticated. Please connect to Google Drive first.</div>';
          return;
        }

        try {
          console.log("üîç Making API request to Google Drive...");
          console.log("Access Token:", accessToken.substring(0, 20) + "...");
          
          // Simplified API call - remove the API key from URL since we're using OAuth
          const apiUrl = `https://www.googleapis.com/drive/v3/files?pageSize=20&fields=files(id,name,mimeType,modifiedTime,size,webViewLink)&orderBy=modifiedTime desc`;
          
          const response = await fetch(apiUrl, {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
            },
          });

          console.log("üì° API Response Status:", response.status);
          console.log("üì° API Response Headers:", Object.fromEntries(response.headers));

          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå API Error Response:", errorText);
            
            if (response.status === 401) {
              throw new Error("Authentication expired - need to reconnect");
            } else if (response.status === 403) {
              throw new Error(`Access denied (403). Check API permissions. Response: ${errorText}`);
            } else if (response.status === 404) {
              throw new Error("Drive API endpoint not found (404)");
            } else {
              throw new Error(`API request failed with status ${response.status}: ${errorText}`);
            }
          }

          const data = await response.json();
          console.log("‚úÖ API Response Data:", data);

          if (!data.files) {
            console.warn("‚ö†Ô∏è No 'files' property in response");
            fileListElement.innerHTML = '<div class="loading" style="color: #dc3545;">Unexpected API response format</div>';
            return;
          }

          const files = data.files;
          
          if (files.length === 0) {
            fileListElement.innerHTML = '<div class="loading">No files found in your Google Drive</div>';
            return;
          }

          console.log(`üìÅ Found ${files.length} files`);

          let fileListHTML = "";
          files.forEach((file, index) => {
            console.log(`File ${index + 1}:`, file.name, file.mimeType);
            
            const icon = getFileIcon(file.mimeType);
            const size = file.size ? formatFileSize(parseInt(file.size)) : "Unknown size";
            const modifiedDate = new Date(file.modifiedTime).toLocaleDateString();
            
            fileListHTML += `
              <div class="file-item">
                <span class="file-icon">${icon}</span>
                <div class="file-info">
                  <div class="file-name">${escapeHtml(file.name)}</div>
                  <div class="file-details">${size} ‚Ä¢ Modified ${modifiedDate}</div>
                </div>
                <button class="file-button" onclick="openFile('${file.webViewLink || `https://drive.google.com/file/d/${file.id}/view`}')">
                  Open
                </button>
              </div>
            `;
          });

          fileListElement.innerHTML = fileListHTML;
          console.log("‚úÖ Files loaded successfully!");
          
        } catch (error) {
          console.error("‚ùå Error loading files:", error);
          
          if (error.message.includes("Authentication expired")) {
            showError("Session expired. Please reconnect to Google Drive.");
            // Clear stored token
            sessionStorage.removeItem('google_drive_token');
            sessionStorage.removeItem('google_drive_token_expiry');
            accessToken = null;
            updateDriveStatus(false);
            hideElement("driveContent");
            hideElement("refreshFilesBtn");
          } else if (error.message.includes("Access denied")) {
            fileListElement.innerHTML = `<div class="loading" style="color: #dc3545;">Access denied. Make sure Google Drive API is enabled in your Google Cloud project.</div>`;
            showError("Google Drive API access denied. Check your API configuration.");
          } else {
            fileListElement.innerHTML = `<div class="loading" style="color: #dc3545;">Error: ${error.message}</div>`;
            showError(`API Error: ${error.message}`);
          }
        }
      }

      function getFileIcon(mimeType) {
        if (mimeType.includes("folder")) return "üìÅ";
        if (mimeType.includes("document")) return "üìÑ";
        if (mimeType.includes("spreadsheet")) return "üìä";
        if (mimeType.includes("presentation")) return "üìΩÔ∏è";
        if (mimeType.includes("image")) return "üñºÔ∏è";
        if (mimeType.includes("video")) return "üé•";
        if (mimeType.includes("audio")) return "üéµ";
        if (mimeType.includes("pdf")) return "üìï";
        return "üìÑ";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      function openFile(url) {
        window.open(url, "_blank");
      }

      // Refresh files
      document
        .getElementById("refreshFilesBtn")
        .addEventListener("click", loadDriveFiles);

      // Disconnect Google Drive
      document
        .getElementById("disconnectDriveBtn")
        .addEventListener("click", function() {
          // Revoke the token and clear storage
          if (accessToken && google && google.accounts && google.accounts.oauth2) {
            google.accounts.oauth2.revoke(accessToken, () => {
              console.log('Access token revoked.');
            });
          }
          
          // Clear stored authentication
          sessionStorage.removeItem('google_drive_token');
          sessionStorage.removeItem('google_drive_token_expiry');
          accessToken = null;
          
          updateDriveStatus(false);
          hideElement("driveContent");
          hideElement("refreshFilesBtn");
          showSuccess("Google Drive disconnected");
        });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", function () {
        // Don't revoke the token - keep it for next login
        // Only clear current session
        current_user = null;
        // Keep accessToken and stored token for next login
        
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        hideElement("driveContent");
        hideElement("refreshFilesBtn");
        hideElement("portalContent");
        showElement("loginForm");
        showSuccess("Logged out successfully");
        
        // Note: Google Drive connection will be restored on next login
        console.log("üìù Logged out - Google Drive connection will be restored on next login");
      });

      // Console instructions
      console.log("üîê Demo Credentials:");
      console.log("Username: admin, Password: admin123");
      console.log("Username: user, Password: user123");
      console.log("");
      console.log("‚úÖ One-time Google Drive connection!");
      console.log("üìÇ Connect once, stay connected across logins");
      console.log("üîÑ Use 'Disconnect Drive' if you want to change accounts");
    </script>
  </body>
</html>
